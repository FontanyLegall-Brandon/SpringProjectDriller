{'_old_path': PosixPath('spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/oauth2/resource/ResourceServerTokenServicesConfiguration.java'), '_new_path': PosixPath('spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/oauth2/resource/ResourceServerTokenServicesConfiguration.java'), 'change_type': <ModificationType.MODIFY: 5>, 'diff': '@@ -15,32 +15,48 @@\n  */\n package org.springframework.boot.autoconfigure.security.oauth2.resource;\n \n+import java.io.IOException;\n+import java.util.Arrays;\n import java.util.Collections;\n+import java.util.List;\n import java.util.Map;\n \n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n import org.springframework.boot.autoconfigure.condition.ConditionOutcome;\n import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;\n import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\n import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingClass;\n import org.springframework.boot.autoconfigure.condition.SpringBootCondition;\n-import org.springframework.boot.autoconfigure.security.oauth2.ClientCredentialsProperties;\n-import org.springframework.boot.autoconfigure.security.oauth2.client.SpringSecurityOAuth2ClientConfiguration;\n-import org.springframework.boot.autoconfigure.security.oauth2.client.SpringSecurityOAuth2ClientConfiguration.ClientAuthenticationFilterConfiguration;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.ConditionContext;\n import org.springframework.context.annotation.Conditional;\n import org.springframework.context.annotation.Configuration;\n-import org.springframework.context.annotation.Import;\n+import org.springframework.core.OrderComparator;\n+import org.springframework.core.annotation.AnnotationAwareOrderComparator;\n import org.springframework.core.env.Environment;\n import org.springframework.core.type.AnnotatedTypeMetadata;\n+import org.springframework.http.HttpEntity;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.http.HttpRequest;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.client.ClientHttpRequestExecution;\n+import org.springframework.http.client.ClientHttpRequestInterceptor;\n+import org.springframework.http.client.ClientHttpResponse;\n+import org.springframework.security.crypto.codec.Base64;\n+import org.springframework.security.oauth2.client.OAuth2ClientContext;\n import org.springframework.security.oauth2.client.OAuth2RestOperations;\n+import org.springframework.security.oauth2.client.OAuth2RestTemplate;\n+import org.springframework.security.oauth2.client.resource.OAuth2ProtectedResourceDetails;\n+import org.springframework.security.oauth2.client.token.AccessTokenRequest;\n+import org.springframework.security.oauth2.client.token.RequestEnhancer;\n+import org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeAccessTokenProvider;\n import org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeResourceDetails;\n import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerEndpointsConfiguration;\n-import org.springframework.security.oauth2.config.annotation.web.configuration.EnableOAuth2Client;\n import org.springframework.security.oauth2.provider.token.DefaultTokenServices;\n import org.springframework.security.oauth2.provider.token.RemoteTokenServices;\n import org.springframework.security.oauth2.provider.token.ResourceServerTokenServices;\n@@ -49,6 +65,7 @@ import org.springframework.security.oauth2.provider.token.store.JwtAccessTokenCo\n import org.springframework.security.oauth2.provider.token.store.JwtTokenStore;\n import org.springframework.social.connect.ConnectionFactoryLocator;\n import org.springframework.social.connect.support.OAuth2ConnectionFactory;\n+import org.springframework.util.MultiValueMap;\n import org.springframework.util.StringUtils;\n import org.springframework.web.client.ResourceAccessException;\n import org.springframework.web.client.RestTemplate;\n@@ -64,29 +81,88 @@ public class ResourceServerTokenServicesConfiguration {\n \tprivate static final Log logger = LogFactory\n \t\t\t.getLog(ResourceServerTokenServicesConfiguration.class);\n \n+\t@Configuration\n+\tprotected static class UserInfoRestTemplateConfiguration {\n+\n+\t\tprivate static final AuthorizationCodeResourceDetails DEFAULT_RESOURCE_DETAILS = new AuthorizationCodeResourceDetails();\n+\n+\t\tstatic {\n+\t\t\tDEFAULT_RESOURCE_DETAILS.setClientId("<N/A>");\n+\t\t\tDEFAULT_RESOURCE_DETAILS\n+\t\t\t\t\t.setUserAuthorizationUri("Not a URI because there is no client");\n+\t\t\tDEFAULT_RESOURCE_DETAILS\n+\t\t\t\t\t.setAccessTokenUri("Not a URI because there is no client");\n+\t\t}\n+\n+\t\t@Autowired(required = false)\n+\t\tprivate List<UserInfoRestTemplateCustomizer> customizers = Collections\n+\t\t\t\t.emptyList();\n+\n+\t\t@Autowired(required = false)\n+\t\tprivate OAuth2ProtectedResourceDetails details;\n+\n+\t\t@Autowired(required = false)\n+\t\tprivate OAuth2ClientContext oauth2ClientContext;\n+\n+\t\t@Bean(name = "userInfoRestTemplate")\n+\t\tpublic OAuth2RestTemplate userInfoRestTemplate() {\n+\t\t\tOAuth2RestTemplate template;\n+\t\t\tif (details == null) {\n+\t\t\t\tdetails = DEFAULT_RESOURCE_DETAILS;\n+\t\t\t}\n+\t\t\tif (oauth2ClientContext == null) {\n+\t\t\t\ttemplate = new OAuth2RestTemplate(details);\n+\t\t\t}\n+\t\t\telse {\n+\t\t\t\ttemplate = new OAuth2RestTemplate(details, oauth2ClientContext);\n+\t\t\t}\n+\t\t\ttemplate.setInterceptors(Arrays\n+\t\t\t\t\t.<ClientHttpRequestInterceptor> asList(new ClientHttpRequestInterceptor() {\n+\t\t\t\t\t\t@Override\n+\t\t\t\t\t\tpublic ClientHttpResponse intercept(HttpRequest request,\n+\t\t\t\t\t\t\t\tbyte[] body, ClientHttpRequestExecution execution)\n+\t\t\t\t\t\t\t\tthrows IOException {\n+\t\t\t\t\t\t\trequest.getHeaders().setAccept(\n+\t\t\t\t\t\t\t\t\tArrays.asList(MediaType.APPLICATION_JSON));\n+\t\t\t\t\t\t\treturn execution.execute(request, body);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}));\n+\t\t\tAuthorizationCodeAccessTokenProvider accessTokenProvider = new AuthorizationCodeAccessTokenProvider();\n+\t\t\taccessTokenProvider.setTokenRequestEnhancer(new RequestEnhancer() {\n+\t\t\t\t@Override\n+\t\t\t\tpublic void enhance(AccessTokenRequest request,\n+\t\t\t\t\t\tOAuth2ProtectedResourceDetails resource,\n+\t\t\t\t\t\tMultiValueMap<String, String> form, HttpHeaders headers) {\n+\t\t\t\t\theaders.setAccept(Arrays.asList(MediaType.APPLICATION_JSON));\n+\t\t\t\t}\n+\t\t\t});\n+\t\t\ttemplate.setAccessTokenProvider(accessTokenProvider);\n+\t\t\tOrderComparator.sort(customizers);\n+\t\t\tfor (UserInfoRestTemplateCustomizer customizer : customizers) {\n+\t\t\t\tcustomizer.customize(template);\n+\t\t\t}\n+\t\t\treturn template;\n+\t\t}\n+\n+\t}\n+\n \t@Configuration\n \t@Conditional(NotJwtToken.class)\n-\t@EnableOAuth2Client\n-\t@Import(ClientAuthenticationFilterConfiguration.class)\n \tprotected static class RemoteTokenServicesConfiguration {\n \n \t\t@Configuration\n-\t\t@Import(SpringSecurityOAuth2ClientConfiguration.class)\n \t\t@Conditional(TokenInfo.class)\n \t\tprotected static class TokenInfoServicesConfiguration {\n \n \t\t\t@Autowired\n \t\t\tprivate ResourceServerProperties resource;\n \n-\t\t\t@Autowired\n-\t\t\tprivate AuthorizationCodeResourceDetails client;\n-\n \t\t\t@Bean\n \t\t\tpublic ResourceServerTokenServices remoteTokenServices() {\n \t\t\t\tRemoteTokenServices services = new RemoteTokenServices();\n \t\t\t\tservices.setCheckTokenEndpointUrl(this.resource.getTokenInfoUri());\n-\t\t\t\tservices.setClientId(this.client.getClientId());\n-\t\t\t\tservices.setClientSecret(this.client.getClientSecret());\n+\t\t\t\tservices.setClientId(this.resource.getClientId());\n+\t\t\t\tservices.setClientSecret(this.resource.getClientSecret());\n \t\t\t\treturn services;\n \t\t\t}\n \n@@ -100,21 +176,19 @@ public class ResourceServerTokenServicesConfiguration {\n \t\t\t@Autowired\n \t\t\tprivate ResourceServerProperties sso;\n \n-\t\t\t@Autowired\n-\t\t\tprivate ClientCredentialsProperties client;\n-\n \t\t\t@Autowired(required = false)\n \t\t\tprivate OAuth2ConnectionFactory<?> connectionFactory;\n \n \t\t\t@Autowired(required = false)\n-\t\t\tprivate Map<String, OAuth2RestOperations> resources = Collections.emptyMap();\n+\t\t\t@Qualifier("userInfoRestTemplate")\n+\t\t\tprivate OAuth2RestOperations restTemplate;\n \n \t\t\t@Bean\n \t\t\t@ConditionalOnBean(ConnectionFactoryLocator.class)\n \t\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n \t\t\tpublic SpringSocialTokenServices socialTokenServices() {\n \t\t\t\treturn new SpringSocialTokenServices(this.connectionFactory,\n-\t\t\t\t\t\tthis.client.getClientId());\n+\t\t\t\t\t\tthis.sso.getClientId());\n \t\t\t}\n \n \t\t\t@Bean\n@@ -122,33 +196,33 @@ public class ResourceServerTokenServicesConfiguration {\n \t\t\t\t\tResourceServerTokenServices.class })\n \t\t\tpublic ResourceServerTokenServices userInfoTokenServices() {\n \t\t\t\tUserInfoTokenServices services = new UserInfoTokenServices(\n-\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.client.getClientId());\n-\t\t\t\tservices.setResources(this.resources);\n+\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.sso.getClientId());\n+\t\t\t\tservices.setTokenType(sso.getTokenType());\n+\t\t\t\tservices.setRestTemplate(restTemplate);\n \t\t\t\treturn services;\n \t\t\t}\n \n \t\t}\n \n \t\t@Configuration\n-\t\t@ConditionalOnMissingClass(name = "org.springframework.social.connect.support.OAuth2ConnectionFactory")\n+\t\t@ConditionalOnMissingClass("org.springframework.social.connect.support.OAuth2ConnectionFactory")\n \t\t@Conditional(NotTokenInfo.class)\n \t\tprotected static class UserInfoTokenServicesConfiguration {\n \n \t\t\t@Autowired\n \t\t\tprivate ResourceServerProperties sso;\n \n-\t\t\t@Autowired\n-\t\t\tprivate ClientCredentialsProperties client;\n-\n \t\t\t@Autowired(required = false)\n-\t\t\tprivate Map<String, OAuth2RestOperations> resources = Collections.emptyMap();\n+\t\t\t@Qualifier("userInfoRestTemplate")\n+\t\t\tprivate OAuth2RestOperations restTemplate;\n \n \t\t\t@Bean\n \t\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n \t\t\tpublic ResourceServerTokenServices userInfoTokenServices() {\n \t\t\t\tUserInfoTokenServices services = new UserInfoTokenServices(\n-\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.client.getClientId());\n-\t\t\t\tservices.setResources(this.resources);\n+\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.sso.getClientId());\n+\t\t\t\tservices.setRestTemplate(restTemplate);\n+\t\t\t\tservices.setTokenType(sso.getTokenType());\n \t\t\t\treturn services;\n \t\t\t}\n \n@@ -160,9 +234,15 @@ public class ResourceServerTokenServicesConfiguration {\n \t@Conditional(JwtToken.class)\n \tprotected static class JwtTokenServicesConfiguration {\n \n+\t\tprivate RestTemplate keyUriRestTemplate = new RestTemplate();\n+\n \t\t@Autowired\n \t\tprivate ResourceServerProperties resource;\n \n+\t\t@Autowired(required = false)\n+\t\tprivate List<JwtAccessTokenConverterConfigurer> configurers = Collections\n+\t\t\t\t.emptyList();\n+\n \t\t@Bean\n \t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n \t\tpublic ResourceServerTokenServices jwtTokenServices() {\n@@ -182,22 +262,34 @@ public class ResourceServerTokenServicesConfiguration {\n \t\t\tString keyValue = this.resource.getJwt().getKeyValue();\n \t\t\tif (!StringUtils.hasText(keyValue)) {\n \t\t\t\ttry {\n-\t\t\t\t\tkeyValue = (String) new RestTemplate().getForObject(\n-\t\t\t\t\t\t\tthis.resource.getJwt().getKeyUri(), Map.class).get("value");\n+\t\t\t\t\tHttpHeaders headers = new HttpHeaders();\n+\t\t\t\t\tif (resource.getClientId() != null\n+\t\t\t\t\t\t\t&& resource.getClientSecret() != null) {\n+\t\t\t\t\t\tbyte[] token = Base64\n+\t\t\t\t\t\t\t\t.encode((resource.getClientId() + ":" + resource\n+\t\t\t\t\t\t\t\t\t\t.getClientSecret()).getBytes());\n+\t\t\t\t\t\theaders.add("Authorization", "Basic " + new String(token));\n+\t\t\t\t\t}\n+\t\t\t\t\tHttpEntity<Void> requestEntity = new HttpEntity<Void>(headers);\n+\t\t\t\t\tkeyValue = (String) keyUriRestTemplate\n+\t\t\t\t\t\t\t.exchange(resource.getJwt().getKeyUri(), HttpMethod.GET,\n+\t\t\t\t\t\t\t\t\trequestEntity, Map.class).getBody().get("value");\n \t\t\t\t}\n \t\t\t\tcatch (ResourceAccessException e) {\n \t\t\t\t\t// ignore\n \t\t\t\t\tlogger.warn("Failed to fetch token key (you may need to refresh when the auth server is back)");\n \t\t\t\t}\n \t\t\t}\n-\t\t\telse {\n-\t\t\t\tif (StringUtils.hasText(keyValue) && !keyValue.startsWith("-----BEGIN")) {\n-\t\t\t\t\tconverter.setSigningKey(keyValue);\n-\t\t\t\t}\n+\t\t\tif (StringUtils.hasText(keyValue) && !keyValue.startsWith("-----BEGIN")) {\n+\t\t\t\tconverter.setSigningKey(keyValue);\n \t\t\t}\n \t\t\tif (keyValue != null) {\n \t\t\t\tconverter.setVerifierKey(keyValue);\n \t\t\t}\n+\t\t\tAnnotationAwareOrderComparator.sort(configurers);\n+\t\t\tfor (JwtAccessTokenConverterConfigurer configurer : configurers) {\n+\t\t\t\tconfigurer.configure(converter);\n+\t\t\t}\n \t\t\treturn converter;\n \t\t}\n \n', 'source_code': '/*\n * Copyright 2013-2014 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the "License");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an "AS IS" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.springframework.boot.autoconfigure.security.oauth2.resource;\n\nimport java.io.IOException;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.List;\nimport java.util.Map;\n\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.boot.autoconfigure.condition.ConditionOutcome;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingClass;\nimport org.springframework.boot.autoconfigure.condition.SpringBootCondition;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.ConditionContext;\nimport org.springframework.context.annotation.Conditional;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.OrderComparator;\nimport org.springframework.core.annotation.AnnotationAwareOrderComparator;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.type.AnnotatedTypeMetadata;\nimport org.springframework.http.HttpEntity;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.http.HttpRequest;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.client.ClientHttpRequestExecution;\nimport org.springframework.http.client.ClientHttpRequestInterceptor;\nimport org.springframework.http.client.ClientHttpResponse;\nimport org.springframework.security.crypto.codec.Base64;\nimport org.springframework.security.oauth2.client.OAuth2ClientContext;\nimport org.springframework.security.oauth2.client.OAuth2RestOperations;\nimport org.springframework.security.oauth2.client.OAuth2RestTemplate;\nimport org.springframework.security.oauth2.client.resource.OAuth2ProtectedResourceDetails;\nimport org.springframework.security.oauth2.client.token.AccessTokenRequest;\nimport org.springframework.security.oauth2.client.token.RequestEnhancer;\nimport org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeAccessTokenProvider;\nimport org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeResourceDetails;\nimport org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerEndpointsConfiguration;\nimport org.springframework.security.oauth2.provider.token.DefaultTokenServices;\nimport org.springframework.security.oauth2.provider.token.RemoteTokenServices;\nimport org.springframework.security.oauth2.provider.token.ResourceServerTokenServices;\nimport org.springframework.security.oauth2.provider.token.TokenStore;\nimport org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;\nimport org.springframework.security.oauth2.provider.token.store.JwtTokenStore;\nimport org.springframework.social.connect.ConnectionFactoryLocator;\nimport org.springframework.social.connect.support.OAuth2ConnectionFactory;\nimport org.springframework.util.MultiValueMap;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.client.ResourceAccessException;\nimport org.springframework.web.client.RestTemplate;\n\n/**\n * @author Dave Syer\n *\n */\n@Configuration\n@ConditionalOnMissingBean(AuthorizationServerEndpointsConfiguration.class)\npublic class ResourceServerTokenServicesConfiguration {\n\n\tprivate static final Log logger = LogFactory\n\t\t\t.getLog(ResourceServerTokenServicesConfiguration.class);\n\n\t@Configuration\n\tprotected static class UserInfoRestTemplateConfiguration {\n\n\t\tprivate static final AuthorizationCodeResourceDetails DEFAULT_RESOURCE_DETAILS = new AuthorizationCodeResourceDetails();\n\n\t\tstatic {\n\t\t\tDEFAULT_RESOURCE_DETAILS.setClientId("<N/A>");\n\t\t\tDEFAULT_RESOURCE_DETAILS\n\t\t\t\t\t.setUserAuthorizationUri("Not a URI because there is no client");\n\t\t\tDEFAULT_RESOURCE_DETAILS\n\t\t\t\t\t.setAccessTokenUri("Not a URI because there is no client");\n\t\t}\n\n\t\t@Autowired(required = false)\n\t\tprivate List<UserInfoRestTemplateCustomizer> customizers = Collections\n\t\t\t\t.emptyList();\n\n\t\t@Autowired(required = false)\n\t\tprivate OAuth2ProtectedResourceDetails details;\n\n\t\t@Autowired(required = false)\n\t\tprivate OAuth2ClientContext oauth2ClientContext;\n\n\t\t@Bean(name = "userInfoRestTemplate")\n\t\tpublic OAuth2RestTemplate userInfoRestTemplate() {\n\t\t\tOAuth2RestTemplate template;\n\t\t\tif (details == null) {\n\t\t\t\tdetails = DEFAULT_RESOURCE_DETAILS;\n\t\t\t}\n\t\t\tif (oauth2ClientContext == null) {\n\t\t\t\ttemplate = new OAuth2RestTemplate(details);\n\t\t\t}\n\t\t\telse {\n\t\t\t\ttemplate = new OAuth2RestTemplate(details, oauth2ClientContext);\n\t\t\t}\n\t\t\ttemplate.setInterceptors(Arrays\n\t\t\t\t\t.<ClientHttpRequestInterceptor> asList(new ClientHttpRequestInterceptor() {\n\t\t\t\t\t\t@Override\n\t\t\t\t\t\tpublic ClientHttpResponse intercept(HttpRequest request,\n\t\t\t\t\t\t\t\tbyte[] body, ClientHttpRequestExecution execution)\n\t\t\t\t\t\t\t\tthrows IOException {\n\t\t\t\t\t\t\trequest.getHeaders().setAccept(\n\t\t\t\t\t\t\t\t\tArrays.asList(MediaType.APPLICATION_JSON));\n\t\t\t\t\t\t\treturn execution.execute(request, body);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\tAuthorizationCodeAccessTokenProvider accessTokenProvider = new AuthorizationCodeAccessTokenProvider();\n\t\t\taccessTokenProvider.setTokenRequestEnhancer(new RequestEnhancer() {\n\t\t\t\t@Override\n\t\t\t\tpublic void enhance(AccessTokenRequest request,\n\t\t\t\t\t\tOAuth2ProtectedResourceDetails resource,\n\t\t\t\t\t\tMultiValueMap<String, String> form, HttpHeaders headers) {\n\t\t\t\t\theaders.setAccept(Arrays.asList(MediaType.APPLICATION_JSON));\n\t\t\t\t}\n\t\t\t});\n\t\t\ttemplate.setAccessTokenProvider(accessTokenProvider);\n\t\t\tOrderComparator.sort(customizers);\n\t\t\tfor (UserInfoRestTemplateCustomizer customizer : customizers) {\n\t\t\t\tcustomizer.customize(template);\n\t\t\t}\n\t\t\treturn template;\n\t\t}\n\n\t}\n\n\t@Configuration\n\t@Conditional(NotJwtToken.class)\n\tprotected static class RemoteTokenServicesConfiguration {\n\n\t\t@Configuration\n\t\t@Conditional(TokenInfo.class)\n\t\tprotected static class TokenInfoServicesConfiguration {\n\n\t\t\t@Autowired\n\t\t\tprivate ResourceServerProperties resource;\n\n\t\t\t@Bean\n\t\t\tpublic ResourceServerTokenServices remoteTokenServices() {\n\t\t\t\tRemoteTokenServices services = new RemoteTokenServices();\n\t\t\t\tservices.setCheckTokenEndpointUrl(this.resource.getTokenInfoUri());\n\t\t\t\tservices.setClientId(this.resource.getClientId());\n\t\t\t\tservices.setClientSecret(this.resource.getClientSecret());\n\t\t\t\treturn services;\n\t\t\t}\n\n\t\t}\n\n\t\t@Configuration\n\t\t@ConditionalOnClass(OAuth2ConnectionFactory.class)\n\t\t@Conditional(NotTokenInfo.class)\n\t\tprotected static class SocialTokenServicesConfiguration {\n\n\t\t\t@Autowired\n\t\t\tprivate ResourceServerProperties sso;\n\n\t\t\t@Autowired(required = false)\n\t\t\tprivate OAuth2ConnectionFactory<?> connectionFactory;\n\n\t\t\t@Autowired(required = false)\n\t\t\t@Qualifier("userInfoRestTemplate")\n\t\t\tprivate OAuth2RestOperations restTemplate;\n\n\t\t\t@Bean\n\t\t\t@ConditionalOnBean(ConnectionFactoryLocator.class)\n\t\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n\t\t\tpublic SpringSocialTokenServices socialTokenServices() {\n\t\t\t\treturn new SpringSocialTokenServices(this.connectionFactory,\n\t\t\t\t\t\tthis.sso.getClientId());\n\t\t\t}\n\n\t\t\t@Bean\n\t\t\t@ConditionalOnMissingBean({ ConnectionFactoryLocator.class,\n\t\t\t\t\tResourceServerTokenServices.class })\n\t\t\tpublic ResourceServerTokenServices userInfoTokenServices() {\n\t\t\t\tUserInfoTokenServices services = new UserInfoTokenServices(\n\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.sso.getClientId());\n\t\t\t\tservices.setTokenType(sso.getTokenType());\n\t\t\t\tservices.setRestTemplate(restTemplate);\n\t\t\t\treturn services;\n\t\t\t}\n\n\t\t}\n\n\t\t@Configuration\n\t\t@ConditionalOnMissingClass("org.springframework.social.connect.support.OAuth2ConnectionFactory")\n\t\t@Conditional(NotTokenInfo.class)\n\t\tprotected static class UserInfoTokenServicesConfiguration {\n\n\t\t\t@Autowired\n\t\t\tprivate ResourceServerProperties sso;\n\n\t\t\t@Autowired(required = false)\n\t\t\t@Qualifier("userInfoRestTemplate")\n\t\t\tprivate OAuth2RestOperations restTemplate;\n\n\t\t\t@Bean\n\t\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n\t\t\tpublic ResourceServerTokenServices userInfoTokenServices() {\n\t\t\t\tUserInfoTokenServices services = new UserInfoTokenServices(\n\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.sso.getClientId());\n\t\t\t\tservices.setRestTemplate(restTemplate);\n\t\t\t\tservices.setTokenType(sso.getTokenType());\n\t\t\t\treturn services;\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t@Configuration\n\t@Conditional(JwtToken.class)\n\tprotected static class JwtTokenServicesConfiguration {\n\n\t\tprivate RestTemplate keyUriRestTemplate = new RestTemplate();\n\n\t\t@Autowired\n\t\tprivate ResourceServerProperties resource;\n\n\t\t@Autowired(required = false)\n\t\tprivate List<JwtAccessTokenConverterConfigurer> configurers = Collections\n\t\t\t\t.emptyList();\n\n\t\t@Bean\n\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n\t\tpublic ResourceServerTokenServices jwtTokenServices() {\n\t\t\tDefaultTokenServices services = new DefaultTokenServices();\n\t\t\tservices.setTokenStore(jwtTokenStore());\n\t\t\treturn services;\n\t\t}\n\n\t\t@Bean\n\t\tpublic TokenStore jwtTokenStore() {\n\t\t\treturn new JwtTokenStore(jwtTokenEnhancer());\n\t\t}\n\n\t\t@Bean\n\t\tpublic JwtAccessTokenConverter jwtTokenEnhancer() {\n\t\t\tJwtAccessTokenConverter converter = new JwtAccessTokenConverter();\n\t\t\tString keyValue = this.resource.getJwt().getKeyValue();\n\t\t\tif (!StringUtils.hasText(keyValue)) {\n\t\t\t\ttry {\n\t\t\t\t\tHttpHeaders headers = new HttpHeaders();\n\t\t\t\t\tif (resource.getClientId() != null\n\t\t\t\t\t\t\t&& resource.getClientSecret() != null) {\n\t\t\t\t\t\tbyte[] token = Base64\n\t\t\t\t\t\t\t\t.encode((resource.getClientId() + ":" + resource\n\t\t\t\t\t\t\t\t\t\t.getClientSecret()).getBytes());\n\t\t\t\t\t\theaders.add("Authorization", "Basic " + new String(token));\n\t\t\t\t\t}\n\t\t\t\t\tHttpEntity<Void> requestEntity = new HttpEntity<Void>(headers);\n\t\t\t\t\tkeyValue = (String) keyUriRestTemplate\n\t\t\t\t\t\t\t.exchange(resource.getJwt().getKeyUri(), HttpMethod.GET,\n\t\t\t\t\t\t\t\t\trequestEntity, Map.class).getBody().get("value");\n\t\t\t\t}\n\t\t\t\tcatch (ResourceAccessException e) {\n\t\t\t\t\t// ignore\n\t\t\t\t\tlogger.warn("Failed to fetch token key (you may need to refresh when the auth server is back)");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (StringUtils.hasText(keyValue) && !keyValue.startsWith("-----BEGIN")) {\n\t\t\t\tconverter.setSigningKey(keyValue);\n\t\t\t}\n\t\t\tif (keyValue != null) {\n\t\t\t\tconverter.setVerifierKey(keyValue);\n\t\t\t}\n\t\t\tAnnotationAwareOrderComparator.sort(configurers);\n\t\t\tfor (JwtAccessTokenConverterConfigurer configurer : configurers) {\n\t\t\t\tconfigurer.configure(converter);\n\t\t\t}\n\t\t\treturn converter;\n\t\t}\n\n\t}\n\n\tprivate static class TokenInfo extends SpringBootCondition {\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tEnvironment environment = context.getEnvironment();\n\t\t\tboolean preferTokenInfo = environment\n\t\t\t\t\t.resolvePlaceholders(\n\t\t\t\t\t\t\t"${spring.oauth2.resource.preferTokenInfo:${OAUTH2_RESOURCE_PREFERTOKENINFO:true}}")\n\t\t\t\t\t.equals("true");\n\t\t\tboolean hasTokenInfo = !environment.resolvePlaceholders(\n\t\t\t\t\t"${spring.oauth2.resource.tokenInfoUri:}").equals("");\n\t\t\tboolean hasUserInfo = !environment.resolvePlaceholders(\n\t\t\t\t\t"${spring.oauth2.resource.userInfoUri:}").equals("");\n\t\t\tif (!hasUserInfo) {\n\t\t\t\treturn ConditionOutcome.match("No user info provided");\n\t\t\t}\n\t\t\tif (hasTokenInfo) {\n\t\t\t\tif (preferTokenInfo) {\n\t\t\t\t\treturn ConditionOutcome\n\t\t\t\t\t\t\t.match("Token info endpoint is preferred and user info provided");\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn ConditionOutcome.noMatch("Token info endpoint is not provided");\n\t\t}\n\n\t}\n\n\tprivate static class JwtToken extends SpringBootCondition {\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tif (StringUtils.hasText(context.getEnvironment().getProperty(\n\t\t\t\t\t"spring.oauth2.resource.jwt.keyValue"))\n\t\t\t\t\t|| StringUtils.hasText(context.getEnvironment().getProperty(\n\t\t\t\t\t\t\t"spring.oauth2.resource.jwt.keyUri"))) {\n\t\t\t\treturn ConditionOutcome.match("public key is provided");\n\t\t\t}\n\t\t\treturn ConditionOutcome.noMatch("public key is not provided");\n\t\t}\n\n\t}\n\n\tprivate static class NotTokenInfo extends SpringBootCondition {\n\n\t\tprivate TokenInfo opposite = new TokenInfo();\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tConditionOutcome outcome = this.opposite.getMatchOutcome(context, metadata);\n\t\t\tif (outcome.isMatch()) {\n\t\t\t\treturn ConditionOutcome.noMatch(outcome.getMessage());\n\t\t\t}\n\t\t\treturn ConditionOutcome.match(outcome.getMessage());\n\t\t}\n\n\t}\n\n\tprivate static class NotJwtToken extends SpringBootCondition {\n\n\t\tprivate JwtToken opposite = new JwtToken();\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tConditionOutcome outcome = this.opposite.getMatchOutcome(context, metadata);\n\t\t\tif (outcome.isMatch()) {\n\t\t\t\treturn ConditionOutcome.noMatch(outcome.getMessage());\n\t\t\t}\n\t\t\treturn ConditionOutcome.match(outcome.getMessage());\n\t\t}\n\n\t}\n}\n', 'source_code_before': '/*\n * Copyright 2013-2014 the original author or authors.\n *\n * Licensed under the Apache License, Version 2.0 (the "License");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an "AS IS" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.springframework.boot.autoconfigure.security.oauth2.resource;\n\nimport java.util.Collections;\nimport java.util.Map;\n\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.autoconfigure.condition.ConditionOutcome;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingClass;\nimport org.springframework.boot.autoconfigure.condition.SpringBootCondition;\nimport org.springframework.boot.autoconfigure.security.oauth2.ClientCredentialsProperties;\nimport org.springframework.boot.autoconfigure.security.oauth2.client.SpringSecurityOAuth2ClientConfiguration;\nimport org.springframework.boot.autoconfigure.security.oauth2.client.SpringSecurityOAuth2ClientConfiguration.ClientAuthenticationFilterConfiguration;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.ConditionContext;\nimport org.springframework.context.annotation.Conditional;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Import;\nimport org.springframework.core.env.Environment;\nimport org.springframework.core.type.AnnotatedTypeMetadata;\nimport org.springframework.security.oauth2.client.OAuth2RestOperations;\nimport org.springframework.security.oauth2.client.token.grant.code.AuthorizationCodeResourceDetails;\nimport org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerEndpointsConfiguration;\nimport org.springframework.security.oauth2.config.annotation.web.configuration.EnableOAuth2Client;\nimport org.springframework.security.oauth2.provider.token.DefaultTokenServices;\nimport org.springframework.security.oauth2.provider.token.RemoteTokenServices;\nimport org.springframework.security.oauth2.provider.token.ResourceServerTokenServices;\nimport org.springframework.security.oauth2.provider.token.TokenStore;\nimport org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;\nimport org.springframework.security.oauth2.provider.token.store.JwtTokenStore;\nimport org.springframework.social.connect.ConnectionFactoryLocator;\nimport org.springframework.social.connect.support.OAuth2ConnectionFactory;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.client.ResourceAccessException;\nimport org.springframework.web.client.RestTemplate;\n\n/**\n * @author Dave Syer\n *\n */\n@Configuration\n@ConditionalOnMissingBean(AuthorizationServerEndpointsConfiguration.class)\npublic class ResourceServerTokenServicesConfiguration {\n\n\tprivate static final Log logger = LogFactory\n\t\t\t.getLog(ResourceServerTokenServicesConfiguration.class);\n\n\t@Configuration\n\t@Conditional(NotJwtToken.class)\n\t@EnableOAuth2Client\n\t@Import(ClientAuthenticationFilterConfiguration.class)\n\tprotected static class RemoteTokenServicesConfiguration {\n\n\t\t@Configuration\n\t\t@Import(SpringSecurityOAuth2ClientConfiguration.class)\n\t\t@Conditional(TokenInfo.class)\n\t\tprotected static class TokenInfoServicesConfiguration {\n\n\t\t\t@Autowired\n\t\t\tprivate ResourceServerProperties resource;\n\n\t\t\t@Autowired\n\t\t\tprivate AuthorizationCodeResourceDetails client;\n\n\t\t\t@Bean\n\t\t\tpublic ResourceServerTokenServices remoteTokenServices() {\n\t\t\t\tRemoteTokenServices services = new RemoteTokenServices();\n\t\t\t\tservices.setCheckTokenEndpointUrl(this.resource.getTokenInfoUri());\n\t\t\t\tservices.setClientId(this.client.getClientId());\n\t\t\t\tservices.setClientSecret(this.client.getClientSecret());\n\t\t\t\treturn services;\n\t\t\t}\n\n\t\t}\n\n\t\t@Configuration\n\t\t@ConditionalOnClass(OAuth2ConnectionFactory.class)\n\t\t@Conditional(NotTokenInfo.class)\n\t\tprotected static class SocialTokenServicesConfiguration {\n\n\t\t\t@Autowired\n\t\t\tprivate ResourceServerProperties sso;\n\n\t\t\t@Autowired\n\t\t\tprivate ClientCredentialsProperties client;\n\n\t\t\t@Autowired(required = false)\n\t\t\tprivate OAuth2ConnectionFactory<?> connectionFactory;\n\n\t\t\t@Autowired(required = false)\n\t\t\tprivate Map<String, OAuth2RestOperations> resources = Collections.emptyMap();\n\n\t\t\t@Bean\n\t\t\t@ConditionalOnBean(ConnectionFactoryLocator.class)\n\t\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n\t\t\tpublic SpringSocialTokenServices socialTokenServices() {\n\t\t\t\treturn new SpringSocialTokenServices(this.connectionFactory,\n\t\t\t\t\t\tthis.client.getClientId());\n\t\t\t}\n\n\t\t\t@Bean\n\t\t\t@ConditionalOnMissingBean({ ConnectionFactoryLocator.class,\n\t\t\t\t\tResourceServerTokenServices.class })\n\t\t\tpublic ResourceServerTokenServices userInfoTokenServices() {\n\t\t\t\tUserInfoTokenServices services = new UserInfoTokenServices(\n\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.client.getClientId());\n\t\t\t\tservices.setResources(this.resources);\n\t\t\t\treturn services;\n\t\t\t}\n\n\t\t}\n\n\t\t@Configuration\n\t\t@ConditionalOnMissingClass(name = "org.springframework.social.connect.support.OAuth2ConnectionFactory")\n\t\t@Conditional(NotTokenInfo.class)\n\t\tprotected static class UserInfoTokenServicesConfiguration {\n\n\t\t\t@Autowired\n\t\t\tprivate ResourceServerProperties sso;\n\n\t\t\t@Autowired\n\t\t\tprivate ClientCredentialsProperties client;\n\n\t\t\t@Autowired(required = false)\n\t\t\tprivate Map<String, OAuth2RestOperations> resources = Collections.emptyMap();\n\n\t\t\t@Bean\n\t\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n\t\t\tpublic ResourceServerTokenServices userInfoTokenServices() {\n\t\t\t\tUserInfoTokenServices services = new UserInfoTokenServices(\n\t\t\t\t\t\tthis.sso.getUserInfoUri(), this.client.getClientId());\n\t\t\t\tservices.setResources(this.resources);\n\t\t\t\treturn services;\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t@Configuration\n\t@Conditional(JwtToken.class)\n\tprotected static class JwtTokenServicesConfiguration {\n\n\t\t@Autowired\n\t\tprivate ResourceServerProperties resource;\n\n\t\t@Bean\n\t\t@ConditionalOnMissingBean(ResourceServerTokenServices.class)\n\t\tpublic ResourceServerTokenServices jwtTokenServices() {\n\t\t\tDefaultTokenServices services = new DefaultTokenServices();\n\t\t\tservices.setTokenStore(jwtTokenStore());\n\t\t\treturn services;\n\t\t}\n\n\t\t@Bean\n\t\tpublic TokenStore jwtTokenStore() {\n\t\t\treturn new JwtTokenStore(jwtTokenEnhancer());\n\t\t}\n\n\t\t@Bean\n\t\tpublic JwtAccessTokenConverter jwtTokenEnhancer() {\n\t\t\tJwtAccessTokenConverter converter = new JwtAccessTokenConverter();\n\t\t\tString keyValue = this.resource.getJwt().getKeyValue();\n\t\t\tif (!StringUtils.hasText(keyValue)) {\n\t\t\t\ttry {\n\t\t\t\t\tkeyValue = (String) new RestTemplate().getForObject(\n\t\t\t\t\t\t\tthis.resource.getJwt().getKeyUri(), Map.class).get("value");\n\t\t\t\t}\n\t\t\t\tcatch (ResourceAccessException e) {\n\t\t\t\t\t// ignore\n\t\t\t\t\tlogger.warn("Failed to fetch token key (you may need to refresh when the auth server is back)");\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (StringUtils.hasText(keyValue) && !keyValue.startsWith("-----BEGIN")) {\n\t\t\t\t\tconverter.setSigningKey(keyValue);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (keyValue != null) {\n\t\t\t\tconverter.setVerifierKey(keyValue);\n\t\t\t}\n\t\t\treturn converter;\n\t\t}\n\n\t}\n\n\tprivate static class TokenInfo extends SpringBootCondition {\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tEnvironment environment = context.getEnvironment();\n\t\t\tboolean preferTokenInfo = environment\n\t\t\t\t\t.resolvePlaceholders(\n\t\t\t\t\t\t\t"${spring.oauth2.resource.preferTokenInfo:${OAUTH2_RESOURCE_PREFERTOKENINFO:true}}")\n\t\t\t\t\t.equals("true");\n\t\t\tboolean hasTokenInfo = !environment.resolvePlaceholders(\n\t\t\t\t\t"${spring.oauth2.resource.tokenInfoUri:}").equals("");\n\t\t\tboolean hasUserInfo = !environment.resolvePlaceholders(\n\t\t\t\t\t"${spring.oauth2.resource.userInfoUri:}").equals("");\n\t\t\tif (!hasUserInfo) {\n\t\t\t\treturn ConditionOutcome.match("No user info provided");\n\t\t\t}\n\t\t\tif (hasTokenInfo) {\n\t\t\t\tif (preferTokenInfo) {\n\t\t\t\t\treturn ConditionOutcome\n\t\t\t\t\t\t\t.match("Token info endpoint is preferred and user info provided");\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn ConditionOutcome.noMatch("Token info endpoint is not provided");\n\t\t}\n\n\t}\n\n\tprivate static class JwtToken extends SpringBootCondition {\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tif (StringUtils.hasText(context.getEnvironment().getProperty(\n\t\t\t\t\t"spring.oauth2.resource.jwt.keyValue"))\n\t\t\t\t\t|| StringUtils.hasText(context.getEnvironment().getProperty(\n\t\t\t\t\t\t\t"spring.oauth2.resource.jwt.keyUri"))) {\n\t\t\t\treturn ConditionOutcome.match("public key is provided");\n\t\t\t}\n\t\t\treturn ConditionOutcome.noMatch("public key is not provided");\n\t\t}\n\n\t}\n\n\tprivate static class NotTokenInfo extends SpringBootCondition {\n\n\t\tprivate TokenInfo opposite = new TokenInfo();\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tConditionOutcome outcome = this.opposite.getMatchOutcome(context, metadata);\n\t\t\tif (outcome.isMatch()) {\n\t\t\t\treturn ConditionOutcome.noMatch(outcome.getMessage());\n\t\t\t}\n\t\t\treturn ConditionOutcome.match(outcome.getMessage());\n\t\t}\n\n\t}\n\n\tprivate static class NotJwtToken extends SpringBootCondition {\n\n\t\tprivate JwtToken opposite = new JwtToken();\n\n\t\t@Override\n\t\tpublic ConditionOutcome getMatchOutcome(ConditionContext context,\n\t\t\t\tAnnotatedTypeMetadata metadata) {\n\t\t\tConditionOutcome outcome = this.opposite.getMatchOutcome(context, metadata);\n\t\t\tif (outcome.isMatch()) {\n\t\t\t\treturn ConditionOutcome.noMatch(outcome.getMessage());\n\t\t\t}\n\t\t\treturn ConditionOutcome.match(outcome.getMessage());\n\t\t}\n\n\t}\n}\n', '_nloc': None, '_complexity': None, '_token_count': None, '_function_list': []}
